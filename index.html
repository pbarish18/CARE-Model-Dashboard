<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C.A.R.E. Model Dashboard</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="root" class="min-h-screen p-6"></div>
    
    <script>
        let data = [];
        let charts = {};
        const NAVY = '#001f3f';
        const ORANGE = '#f76900';
        
        let state = {
            school: 'ALL',
            year: 'ALL',
            conf: 'ALL',
            subdiv: 'ALL',
            rolling: 1
        };
        
        // Load data
        fetch('CAREModel20052024_011625.xlsx')
            .then(r => r.arrayBuffer())
            .then(buf => {
                const wb = XLSX.read(buf, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                data = XLSX.utils.sheet_to_json(ws);
                console.log('Data loaded:', data.length, 'rows');
                console.log('Sample row:', data[0]);
                render();
            })
            .catch(err => {
                console.error('Load error:', err);
                document.getElementById('root').innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center p-6 bg-red-50 rounded-lg max-w-lg">
                            <div class="text-2xl font-bold text-red-600 mb-2">Error Loading Data</div>
                            <div class="mb-2">${err.message}</div>
                            <div class="text-sm">Make sure CAREModel20052024_011625.xlsx is in your repository root</div>
                        </div>
                    </div>
                `;
            });
        
        function getFiltered() {
            return data.filter(r => 
                (state.school === 'ALL' || r.Institution === state.school) &&
                (state.year === 'ALL' || String(r.FY) === String(state.year)) &&
                (state.conf === 'ALL' || r.Conference === state.conf) &&
                (state.subdiv === 'ALL' || r['Division I Subdivision'] === state.subdiv)
            );
        }
        
        function calcRolling(yrs) {
            const res = {};
            data.forEach(r => {
                const inst = r.Institution;
                const yr = r.FY;
                const ratio = r['C.A.R.E. Model Ratio'];
                
                if (!inst || !yr || ratio == null || isNaN(ratio)) return;
                
                if (!res[inst]) res[inst] = {};
                
                const vals = [];
                for (let i = 0; i < yrs; i++) {
                    const targetYear = yr - i;
                    const d = data.find(x => x.Institution === inst && x.FY === targetYear);
                    if (d && d['C.A.R.E. Model Ratio'] != null && !isNaN(d['C.A.R.E. Model Ratio'])) {
                        vals.push(d['C.A.R.E. Model Ratio']);
                    }
                }
                
                if (vals.length === yrs) {
                    res[inst][yr] = vals.reduce((a, b) => a + b, 0) / vals.length;
                }
            });
            return res;
        }
        
        function getTrend() {
            const rollAvgs = calcRolling(state.rolling);
            const yd = {};
            
            Object.keys(rollAvgs).forEach(inst => {
                Object.keys(rollAvgs[inst]).forEach(yr => {
                    const yearNum = parseInt(yr);
                    const or = data.find(r => r.Institution === inst && r.FY === yearNum);
                    
                    if (state.school !== 'ALL' && inst !== state.school) return;
                    if (state.conf !== 'ALL' && or?.Conference !== state.conf) return;
                    if (state.subdiv !== 'ALL' && or?.['Division I Subdivision'] !== state.subdiv) return;
                    
                    if (!yd[yearNum]) {
                        yd[yearNum] = { sum: 0, count: 0, year: yearNum };
                    }
                    yd[yearNum].sum += rollAvgs[inst][yr];
                    yd[yearNum].count++;
                });
            });
            
            const result = Object.values(yd)
                .map(i => ({
                    year: i.year,
                    avgRatio: i.sum / i.count
                }))
                .sort((a, b) => a.year - b.year);
            
            console.log('Trend data:', result);
            return result;
        }
        
        function getTop() {
            const rollAvgs = calcRolling(state.rolling);
            const sa = {};
            
            Object.keys(rollAvgs).forEach(inst => {
                const rats = Object.values(rollAvgs[inst]);
                const ors = data.filter(r => r.Institution === inst);
                
                if (state.conf !== 'ALL' && !ors.some(r => r.Conference === state.conf)) return;
                if (state.subdiv !== 'ALL' && !ors.some(r => r['Division I Subdivision'] === state.subdiv)) return;
                
                if (rats.length > 0) {
                    sa[inst] = {
                        school: inst,
                        avgRatio: rats.reduce((a, b) => a + b, 0) / rats.length
                    };
                }
            });
            
            const result = Object.values(sa)
                .sort((a, b) => b.avgRatio - a.avgRatio)
                .slice(0, 15);
            
            console.log('Top schools:', result);
            return result;
        }
        
        function destroyCharts() {
            Object.values(charts).forEach(c => {
                if (c && typeof c.destroy === 'function') {
                    c.destroy();
                }
            });
            charts = {};
        }
        
        function createTrendChart() {
            const trend = getTrend();
            const ctx = document.getElementById('trendChart');
            
            if (!ctx) {
                console.error('Trend chart canvas not found');
                return;
            }
            
            if (trend.length === 0) {
                console.warn('No trend data available');
                ctx.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No data available for selected filters and rolling average period</p>';
                return;
            }
            
            console.log('Creating trend chart with', trend.length, 'points');
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trend.map(t => t.year),
                    datasets: [{
                        label: 'Avg C.A.R.E. Ratio',
                        data: trend.map(t => t.avgRatio),
                        borderColor: NAVY,
                        backgroundColor: NAVY + '20',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'C.A.R.E. Ratio'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });
        }
        
        function createTopChart() {
            const top = getTop();
            const ctx = document.getElementById('topChart');
            
            if (!ctx) {
                console.error('Top chart canvas not found');
                return;
            }
            
            if (top.length === 0) {
                console.warn('No top schools data available');
                ctx.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No data available for selected filters</p>';
                return;
            }
            
            console.log('Creating top chart with', top.length, 'schools');
            
            charts.top = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top.map(t => t.school),
                    datasets: [{
                        label: 'Avg Ratio',
                        data: top.map(t => t.avgRatio),
                        backgroundColor: ORANGE
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Average C.A.R.E. Ratio'
                            }
                        }
                    }
                }
            });
        }
        
        function render() {
            const schools = [...new Set(data.map(r => r.Institution).filter(Boolean))].sort();
            const confs = [...new Set(data.map(r => r.Conference).filter(Boolean))].sort();
            const subdivs = [...new Set(data.map(r => r['Division I Subdivision']).filter(Boolean))].sort();
            const years = [...new Set(data.map(r => r.FY).filter(Boolean))].sort((a, b) => a - b);
            const filtered = getFiltered();
            const trend = getTrend();
            const rlbl = state.rolling === 1 ? '1-Year' : state.rolling === 20 ? 'Full Period' : `${state.rolling}-Year Rolling`;
            
            console.log('Rendering with state:', state);
            console.log('Filtered rows:', filtered.length);
            
            document.getElementById('root').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="rounded-lg shadow-lg p-6 mb-6" style="background-color: ${NAVY}; color: white;">
                        <h1 class="text-3xl font-bold mb-2">C.A.R.E. Model Dashboard</h1>
                        <p class="mb-4 opacity-90">Knight Commission - FY 2005-2024</p>
                        <p class="text-sm opacity-80">C.A.R.E. Ratio = (Aid + Meals + Medical) / Shared Revenue</p>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4">Filters</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Rolling Average</label>
                                <select id="rolling" class="w-full p-2 border rounded-md">
                                    <option value="1">1-Year</option>
                                    <option value="3">3-Year</option>
                                    <option value="5">5-Year</option>
                                    <option value="10">10-Year</option>
                                    <option value="20">Full Period</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">School</label>
                                <select id="school" class="w-full p-2 border rounded-md">
                                    <option value="ALL">All Schools</option>
                                    ${schools.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Conference</label>
                                <select id="conf" class="w-full p-2 border rounded-md">
                                    <option value="ALL">All</option>
                                    ${confs.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Subdivision</label>
                                <select id="subdiv" class="w-full p-2 border rounded-md">
                                    <option value="ALL">All</option>
                                    ${subdivs.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Year (for table only)</label>
                                <select id="year" class="w-full p-2 border rounded-md">
                                    <option value="ALL">All Years</option>
                                    ${years.map(y => `<option value="${y}">${y}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow p-4" style="border-top: 4px solid ${NAVY}">
                            <h3 class="text-sm font-medium text-gray-600">Records</h3>
                            <p class="text-2xl font-bold" style="color: ${NAVY}">${filtered.length}</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4" style="border-top: 4px solid ${ORANGE}">
                            <h3 class="text-sm font-medium text-gray-600">Schools</h3>
                            <p class="text-2xl font-bold" style="color: ${ORANGE}">${state.school === 'ALL' ? schools.length : 1}</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4" style="border-top: 4px solid ${NAVY}">
                            <h3 class="text-sm font-medium text-gray-600">Years</h3>
                            <p class="text-2xl font-bold" style="color: ${NAVY}">${years.length > 0 ? `${Math.min(...years)}-${Math.max(...years)}` : 'N/A'}</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4" style="border-top: 4px solid ${ORANGE}">
                            <h3 class="text-sm font-medium text-gray-600">Avg Ratio</h3>
                            <p class="text-2xl font-bold" style="color: ${ORANGE}">${trend.length ? (trend.reduce((s, r) => s + r.avgRatio, 0) / trend.length).toFixed(2) : 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4">Trend (${rlbl})</h2>
                        <div style="height: 300px;" id="trendContainer">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4">Top 15 Schools (${rlbl})</h2>
                        <div style="height: 400px;" id="topContainer">
                            <canvas id="topChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-semibold mb-4">Data Table</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Year</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">School</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Conf</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Subdiv</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium uppercase">Ratio</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${filtered.slice(0, 50).map(r => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-sm">${r.FY || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${r.Institution || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${r.Conference || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${r['Division I Subdivision'] || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm text-right">${r['C.A.R.E. Model Ratio'] != null ? r['C.A.R.E. Model Ratio'].toFixed(2) : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${filtered.length > 50 ? `<p class="text-sm text-gray-500 mt-4">Showing 50 of ${filtered.length} records</p>` : ''}
                            ${filtered.length === 0 ? `<p class="text-center text-gray-500 py-4">No data matches selected filters</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Set select values
            document.getElementById('rolling').value = state.rolling;
            document.getElementById('school').value = state.school;
            document.getElementById('conf').value = state.conf;
            document.getElementById('subdiv').value = state.subdiv;
            document.getElementById('year').value = state.year;
            
            // Add event listeners
            document.getElementById('rolling').onchange = (e) => {
                state.rolling = parseInt(e.target.value);
                console.log('Rolling changed to:', state.rolling);
                destroyCharts();
                render();
            };
            document.getElementById('school').onchange = (e) => {
                state.school = e.target.value;
                console.log('School changed to:', state.school);
                destroyCharts();
                render();
            };
            document.getElementById('conf').onchange = (e) => {
                state.conf = e.target.value;
                console.log('Conference changed to:', state.conf);
                destroyCharts();
                render();
            };
            document.getElementById('subdiv').onchange = (e) => {
                state.subdiv = e.target.value;
                console.log('Subdivision changed to:', state.subdiv);
                destroyCharts();
                render();
            };
            document.getElementById('year').onchange = (e) => {
                state.year = e.target.value;
                console.log('Year changed to:', state.year);
                render();
            };
            
            // Create charts after DOM is ready
            destroyCharts();
            setTimeout(() => {
                createTrendChart();
                createTopChart();
            }, 100);
        }
    </script>
</body>
</html>
